# Version 1.5.0: Google OAuth Integration - Implementation Plan

**Feature:** Add Google OAuth sign-in capability to enhance user login experience

## Current State

The expense tracker currently uses AWS Cognito User Pools with email/password authentication. Users must create an account with email and password, then confirm their email address before accessing the application.

**Current Cognito Configuration:**
- User Pool ID: `us-east-1_7H7R5DVZT`
- App Client ID: `pk3l1fkkre0ms4si0prabfavl`
- Region: `us-east-1`
- Authentication: Email/Password only
- Frontend: Custom login/signup forms using Cognito SDK directly

## Desired State

Users will have the option to sign in using their Google account in addition to the existing email/password method. This provides a more convenient authentication experience and reduces friction for new users.

## Implementation Approach

The implementation will use **AWS Cognito Hosted UI** with Google as a federated identity provider. This approach is recommended because it handles the OAuth flow securely and requires minimal frontend changes.

### Architecture Overview

```
User → Click "Sign in with Google" 
     → Redirect to Cognito Hosted UI 
     → Redirect to Google OAuth 
     → User authorizes 
     → Redirect back to Cognito 
     → Redirect to app with authorization code 
     → Exchange code for tokens 
     → User authenticated
```

## Manual Steps Required (User Actions)

### Step 1: Google Cloud Console Setup

You will need to create OAuth 2.0 credentials in Google Cloud Console:

1. **Navigate to Google Cloud Console**
   - Go to https://console.cloud.google.com
   - Select your project or create a new one

2. **Configure OAuth Consent Screen**
   - Go to "APIs & Services" → "OAuth consent screen"
   - Choose "External" user type
   - Fill in required information:
     - App name: `Expense Tracker` (or your preferred name)
     - User support email: Your email address
     - Authorized domains: `twin-wicks.com`
     - Developer contact information: Your email address
   - Add scopes: `email`, `profile`, `openid`
   - Save and continue

3. **Create OAuth 2.0 Credentials**
   - Go to "APIs & Services" → "Credentials"
   - Click "Create Credentials" → "OAuth client ID"
   - Application type: `Web application`
   - Name: `Expense Tracker - Cognito`
   - Authorized JavaScript origins:
     - `https://app.twin-wicks.com`
   - Authorized redirect URIs (will be provided after Cognito domain setup):
     - `https://<cognito-domain>.auth.us-east-1.amazoncognito.com/oauth2/idpresponse`
   - Click "Create"
   - **Save the Client ID and Client Secret** (you'll need these for Cognito configuration)

### Step 2: AWS Cognito Configuration

I will need you to perform these steps in the AWS Console (or provide me with the necessary IAM permissions):

1. **Configure Cognito Domain** (if not already configured)
   - Go to AWS Cognito Console
   - Select User Pool: `us-east-1_7H7R5DVZT`
   - Go to "App integration" → "Domain"
   - Choose a domain prefix (e.g., `expense-tracker-prod`)
   - Save the domain
   - **Provide me with the full domain URL**

2. **Add Google as Identity Provider**
   - In the same User Pool, go to "Sign-in experience" → "Federated identity provider sign-in"
   - Click "Add identity provider"
   - Select "Google"
   - Enter the Client ID from Google
   - Enter the Client Secret from Google
   - Set authorized scopes: `profile email openid`
   - Save

3. **Configure App Client OAuth Settings**
   - Go to "App integration" → "App clients"
   - Select the app client: `pk3l1fkkre0ms4si0prabfavl`
   - Click "Edit" under "Hosted UI settings"
   - Configure:
     - **Allowed callback URLs:** `https://app.twin-wicks.com/callback` (or your preferred callback path)
     - **Allowed sign-out URLs:** `https://app.twin-wicks.com`
     - **Identity providers:** Check both "Cognito User Pool" and "Google"
     - **OAuth 2.0 grant types:** Check "Authorization code grant"
     - **OpenID Connect scopes:** Check `openid`, `email`, `profile`
   - Save changes

4. **Update Google Redirect URI**
   - After configuring the Cognito domain, go back to Google Cloud Console
   - Edit the OAuth client credentials
   - Add the Cognito callback URL to "Authorized redirect URIs":
     - `https://<cognito-domain>.auth.us-east-1.amazoncognito.com/oauth2/idpresponse`
   - Save

### Information I Need from You

After completing the manual steps, please provide:
1. **Google Client ID**
2. **Google Client Secret** (I won't store this in git, will use environment variable or AWS Secrets Manager)
3. **Cognito Domain** (the full URL, e.g., `https://expense-tracker-prod.auth.us-east-1.amazoncognito.com`)
4. **Callback URL preference** (default: `https://app.twin-wicks.com/callback`)

## Automated Steps (What I Will Implement)

### Frontend Changes

1. **Update Login Page UI**
   - Add "Sign in with Google" button
   - Keep existing email/password login form
   - Add visual separator (e.g., "OR")
   - Style Google button according to Google's branding guidelines

2. **Implement OAuth Flow Handler**
   - Create new JavaScript module for OAuth handling
   - Implement redirect to Cognito Hosted UI with Google provider
   - Create callback handler to receive authorization code
   - Exchange authorization code for tokens
   - Store tokens in session storage
   - Update user state

3. **Update Authentication Logic**
   - Modify existing auth functions to support both methods
   - Handle federated user attributes (Google users may have different attribute structure)
   - Update token refresh logic
   - Handle sign-out for federated users

4. **Create Callback Page**
   - New route/page to handle OAuth callback
   - Parse authorization code from URL
   - Exchange code for tokens
   - Redirect to dashboard on success
   - Handle errors gracefully

### Configuration Updates

1. **Update app.js Configuration**
   - Add Cognito domain URL
   - Add OAuth configuration (scopes, response type, etc.)
   - Add callback URL

2. **Environment-Specific Settings**
   - Ensure configuration works for both development and production

### Testing

1. **Test Google Sign-In Flow**
   - New user sign-in with Google
   - Existing user sign-in with Google
   - Token refresh
   - Sign-out

2. **Test Email/Password Flow**
   - Ensure existing authentication still works
   - Test all existing features with both auth methods

3. **Test Edge Cases**
   - User cancels Google authorization
   - Invalid callback
   - Expired tokens
   - Network errors

## Implementation Timeline

### Phase 1: Manual Setup (User Actions)
- Google Cloud Console configuration
- AWS Cognito configuration
- Provide credentials and URLs

### Phase 2: Frontend Implementation (Automated)
- Update login page UI
- Implement OAuth flow
- Create callback handler
- Update authentication logic

### Phase 3: Testing & Deployment
- Test both authentication methods
- Deploy to production
- Update documentation

## Security Considerations

1. **Token Storage:** Tokens will be stored in session storage (not local storage) for better security
2. **HTTPS Only:** All OAuth redirects require HTTPS
3. **State Parameter:** Will implement CSRF protection using state parameter
4. **Scope Limitation:** Only request necessary scopes (openid, email, profile)
5. **Token Validation:** Validate tokens before accepting authentication

## User Experience Enhancements

1. **Seamless Integration:** Users can choose their preferred sign-in method
2. **Faster Onboarding:** New users can sign up with one click using Google
3. **No Password Management:** Google users don't need to remember another password
4. **Consistent Experience:** Both auth methods lead to the same application features

## Rollback Plan

If issues arise, we can:
1. Remove Google button from UI (frontend-only change)
2. Disable Google identity provider in Cognito (no code changes needed)
3. Revert to previous version if necessary

## Documentation Updates

Will update:
- README.md with new authentication options
- CHANGELOG.md with v1.5.0 changes
- User guide with Google sign-in instructions
- Architecture documentation

## Questions for Discussion

1. **Do you want to keep email/password authentication?** (Recommended: Yes, offer both options)
2. **What should happen if a user signs up with email/password and later tries to sign in with Google using the same email?** (Cognito can link accounts or treat them separately)
3. **Do you have an existing Google Cloud Console project, or should I guide you through creating a new one?**
4. **What callback URL do you prefer?** (e.g., `/callback`, `/auth/callback`, or just `/`)
5. **Do you want to display user's Google profile picture in the app?** (We can fetch this from Google)

