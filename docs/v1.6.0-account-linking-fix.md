# Version 1.6.0 - Account Linking Fix

**Date:** November 7, 2025  
**Issue:** OAuth callback error: "user.email: Attribute cannot be updated"  
**Status:** ✅ RESOLVED

---

## Problem Summary

When attempting to sign in with Google OAuth for an account that already existed as email/password, Cognito threw an error:

```
https://app.twin-wicks.com/callback?error_description=user.email%3A+Attribute+cannot+be+updated.%0A+&error=invalid_request
```

**Root Cause** (identified by Perplexity AI):
- Cognito attempts to update the email attribute during OAuth login due to attribute mapping
- For email/password users, the email attribute is immutable
- The Post-Authentication Lambda trigger executes AFTER the OAuth callback, which is too late
- Accounts must be linked BEFORE the first OAuth login attempt

---

## Solution Implemented

### Immediate Fix: Manual Account Linking

For existing duplicate accounts (like twinwicksllc@gmail.com), we manually linked them using AWS CLI:

```bash
# 1. Found both accounts
aws cognito-idp list-users \
  --user-pool-id us-east-1_7H7R5DVZT \
  --filter "email = \"twinwicksllc@gmail.com\""

# Results:
# - Email/Password: d4d864a8-f091-7015-dfa4-0821838e3ca9 (email verified)
# - Google OAuth: Google_113592101542572736063 (email NOT verified)

# 2. Linked Google account to email/password account
aws cognito-idp admin-link-provider-for-user \
  --user-pool-id us-east-1_7H7R5DVZT \
  --destination-user ProviderName=Cognito,ProviderAttributeName=sub,ProviderAttributeValue=d4d864a8-f091-7015-dfa4-0821838e3ca9 \
  --source-user ProviderName=Google,ProviderAttributeName=Cognito_Subject,ProviderAttributeValue=64c8d4e8-70e1-7091-80db-c10ba5adcf6b
```

**Result:** ✅ Accounts successfully linked. User can now sign in with either method.

---

## How It Works Now

### For Existing Duplicate Accounts

**Before Fix:**
1. User tries to sign in with Google
2. Cognito attempts OAuth callback
3. Tries to update email attribute (immutable)
4. Error: "Attribute cannot be updated"
5. User cannot sign in

**After Fix:**
1. Accounts pre-linked manually via AWS CLI
2. User signs in with Google
3. Cognito recognizes linked account
4. No attribute update needed
5. ✅ Sign-in successful

### For New Users (No Duplicates)

The Post-Authentication Lambda trigger (`expense-tracker-prod-postauth-link`) still provides value for NEW users:

**Scenario:** User creates email/password account first, then later tries Google OAuth

1. User creates account via email/password
2. User later clicks "Sign in with Google" (same email)
3. Cognito creates NEW Google OAuth account (separate from email/password)
4. Post-Authentication trigger executes
5. Lambda detects duplicate email
6. Lambda links accounts automatically
7. ✅ Future sign-ins work with either method

**Note:** This only works if the user successfully completes OAuth login at least once. If they have an existing email/password account and try Google for the first time, they'll get the attribute error unless accounts are pre-linked.

---

## Long-Term Solution

### Option 1: Pre-Authentication Lambda (Recommended)

Create a Pre-Authentication Lambda that checks for duplicate accounts and links them BEFORE the OAuth callback:

**Pros:**
- Prevents the attribute update error
- Automatic linking before first OAuth login
- No manual intervention needed

**Cons:**
- Pre-Authentication trigger has limited access to user data
- Cannot use AdminLinkProviderForUser in Pre-Authentication context
- More complex implementation

### Option 2: Proactive Account Auditor (Current Approach)

Keep the Post-Authentication trigger and add a scheduled Lambda that:
- Runs daily to find duplicate accounts (same email, different providers)
- Links them proactively before users attempt OAuth login
- Sends notifications to users about linked accounts

**Pros:**
- Simpler implementation
- Works with existing infrastructure
- Can handle bulk linking

**Cons:**
- Requires scheduled job
- Not real-time (daily batch process)
- Users may encounter error before accounts are linked

### Option 3: Make Email Attribute Writable

Update Cognito User Pool configuration to make email attribute writable:

**Pros:**
- Simplest fix
- No Lambda changes needed
- Works immediately

**Cons:**
- Security risk (users could change email to someone else's)
- Not recommended by AWS best practices
- Could enable account takeover attacks

---

## Current Implementation Status

### What's Deployed

1. **Post-Authentication Lambda:** `expense-tracker-prod-postauth-link`
   - Configured and active
   - Links accounts AFTER successful authentication
   - Works for new users who complete OAuth login

2. **Manual Linking Process:** Documented and tested
   - Successfully linked twinwicksllc@gmail.com accounts
   - Process can be repeated for other duplicate accounts

3. **Documentation:** Complete
   - Root cause analysis
   - Solution steps
   - Future recommendations

### What's NOT Deployed

1. **Pre-Authentication Trigger:** Not implemented
   - Would require significant changes
   - Cognito limitations make this challenging

2. **Scheduled Auditor:** Not implemented
   - Could be added in future version
   - Would prevent future attribute errors

3. **Email Attribute Writability:** Not changed
   - Intentionally kept as immutable for security
   - Recommended by AWS best practices

---

## Testing Results

### Test Case: twinwicksllc@gmail.com

**Before Linking:**
- ❌ Google OAuth login failed with "Attribute cannot be updated" error
- ✅ Email/password login worked
- Separate accounts with separate data

**After Linking:**
- ✅ Google OAuth login successful
- ✅ Email/password login successful
- ✅ Same data accessible from both methods
- ✅ Single user identity maintained

**Verification:**
```json
{
  "Username": "d4d864a8-f091-7015-dfa4-0821838e3ca9",
  "Email": "twinwicksllc@gmail.com",
  "Identities": "[{\"dateCreated\":\"1762557558825\",\"userId\":\"64c8d4e8-70e1-7091-80db-c10ba5adcf6b\",\"providerName\":\"Google\",\"providerType\":\"Google\",\"issuer\":null,\"primary\":\"false\"}]"
}
```

---

## Future Enhancements

### Priority 1: Scheduled Account Auditor

Create a Lambda function that runs daily to:
1. List all users in Cognito User Pool
2. Group by email address
3. Identify duplicates (same email, different providers)
4. Link accounts automatically
5. Log linking events to CloudWatch
6. Send email notifications to affected users

**Implementation:**
```javascript
// Pseudo-code for scheduled auditor
async function auditAndLinkAccounts() {
  const users = await cognito.listUsers({ UserPoolId });
  const emailGroups = groupByEmail(users);
  
  for (const [email, accounts] of Object.entries(emailGroups)) {
    if (accounts.length > 1) {
      const nativeAccount = accounts.find(a => !a.username.startsWith('Google_'));
      const googleAccount = accounts.find(a => a.username.startsWith('Google_'));
      
      if (nativeAccount && googleAccount) {
        await linkAccounts(nativeAccount, googleAccount);
        await sendNotification(email, 'Accounts linked');
      }
    }
  }
}
```

### Priority 2: User Notification System

Add frontend notification when accounts are linked:
- Toast message: "Your Google and email accounts have been linked"
- Settings page showing linked providers
- Option to unlink accounts (with warning)

### Priority 3: Account Management UI

Create a Settings page section for account management:
- Display all linked authentication methods
- Show primary account
- Allow unlinking (with data migration warning)
- View linking history

---

## Lessons Learned

### Key Takeaways

1. **Lambda Trigger Timing Matters**
   - Post-Authentication is too late for OAuth attribute conflicts
   - Pre-Authentication has limited capabilities
   - Manual or scheduled linking is more reliable

2. **Cognito Attribute Immutability**
   - Email attributes are immutable by default for security
   - Cannot be updated during OAuth callback
   - Accounts must be linked before first OAuth login

3. **Perplexity AI Validation**
   - Caught the timing issue early
   - Recommended manual linking approach
   - Prevented wasted development time

4. **Testing with Real Accounts**
   - Discovered the issue during actual user testing
   - Manual linking proved effective
   - Documentation critical for future cases

### Best Practices Established

1. **Always consult Perplexity before implementing auth changes**
2. **Test with real duplicate accounts before deployment**
3. **Document manual processes for edge cases**
4. **Keep email attributes immutable for security**
5. **Provide clear error messages to users**

---

## Manual Linking Process (For Future Use)

If another user encounters this error, follow these steps:

### Step 1: Identify Duplicate Accounts

```bash
aws cognito-idp list-users \
  --user-pool-id us-east-1_7H7R5DVZT \
  --filter "email = \"USER_EMAIL_HERE\"" \
  --query 'Users[*].{Username:Username,Email:Attributes[?Name==`email`].Value|[0],Sub:Attributes[?Name==`sub`].Value|[0],EmailVerified:Attributes[?Name==`email_verified`].Value|[0]}'
```

### Step 2: Identify Account Types

- **Email/Password Account:** Username is a UUID (e.g., `d4d864a8-f091-7015-dfa4-0821838e3ca9`)
- **Google OAuth Account:** Username starts with `Google_` (e.g., `Google_113592101542572736063`)

### Step 3: Link Accounts

```bash
aws cognito-idp admin-link-provider-for-user \
  --user-pool-id us-east-1_7H7R5DVZT \
  --destination-user ProviderName=Cognito,ProviderAttributeName=sub,ProviderAttributeValue=EMAIL_PASSWORD_SUB \
  --source-user ProviderName=Google,ProviderAttributeName=Cognito_Subject,ProviderAttributeValue=GOOGLE_OAUTH_SUB
```

### Step 4: Verify Linking

```bash
aws cognito-idp admin-get-user \
  --user-pool-id us-east-1_7H7R5DVZT \
  --username EMAIL_PASSWORD_USERNAME \
  --query '{Username:Username,Email:UserAttributes[?Name==`email`].Value|[0],Identities:UserAttributes[?Name==`identities`].Value|[0]}'
```

### Step 5: Test Login

1. Navigate to https://app.twin-wicks.com
2. Click "Sign in with Google"
3. Should successfully authenticate
4. Verify data is accessible

---

## Version Control

**Git Commit:** v1.6.0  
**Files Changed:**
- `lambda/post-authentication-link.js` (created)
- `CHANGELOG.md` (updated)
- `docs/cognito-trigger-setup.md` (created)
- `docs/v1.6.0-account-linking-fix.md` (created)

**Deployment:**
- Lambda function deployed: ✅
- Cognito trigger configured: ✅
- Manual account linking: ✅
- Documentation: ✅

---

## Support

### Common Questions

**Q: Why can't the Lambda prevent this error?**  
A: The error occurs during the OAuth callback, before any Lambda triggers execute. Lambda triggers only run after successful authentication.

**Q: Will new users have this problem?**  
A: No, new users who create only one account type won't have this issue. The problem only affects users with duplicate accounts created before linking.

**Q: Can I unlink accounts later?**  
A: Yes, but it requires manual intervention via AWS CLI. There's no UI for unlinking currently.

**Q: What happens to my data when accounts are linked?**  
A: All data remains associated with the primary (email/password) account. Nothing is lost.

---

## References

- Perplexity AI analysis: `/tmp/oauth_fix.txt`
- AWS Cognito documentation: [AdminLinkProviderForUser](https://docs.aws.amazon.com/cognito-user-identity-pools/latest/APIReference/API_AdminLinkProviderForUser.html)
- Original implementation plan: `/home/ubuntu/account-linking-final-plan.md`

---

**Resolution:** ✅ Complete  
**User Impact:** Minimal (single manual linking required)  
**Future Prevention:** Scheduled auditor recommended  
**Documentation:** Complete
